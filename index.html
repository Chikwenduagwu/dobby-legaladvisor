<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dobby Legal Advisor (Pidgin)</title>
  <!-- Add minimal styling -->
  <style>
    body{font-family:sans-serif;background:#f2f2f7;padding:20px;}
    textarea, .response{width:100%;border:1px solid #ccc;padding:10px;border-radius:6px;margin-top:6px;}
    button{background:#ff6600;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin-top:10px;}
    .response{min-height:100px;white-space:pre-wrap;}
    .section {margin-bottom:20px;}
  </style>
</head>
<body>
  <h1>Dobby Legal Advisor (Pidgin)</h1>

  <div class="section">
    <label>Enter your legal issue or search term:</label>
    <textarea id="userInput" placeholder="e.g., Trump evictions 2025"></textarea>
    <button onclick="getAdvice()">Ask Dobby</button>
  </div>

  <div class="section">
    <strong>Relevant Federal Register Text:</strong>
    <div class="response" id="fedResponse"></div>
  </div>

  <div class="section">
    <strong>Relevant Case Opinion:</strong>
    <div class="response" id="caseResponse"></div>
  </div>

  <div class="section">
    <strong>Dobby Advice (Pidgin):</strong>
    <div class="response" id="aiResponse">Dobby go talk soon...</div>
  </div>

<script>
  const FIREWORKS_KEY = "fw_3ZYt5vRJztdY1fXajRko5YCt";
  const MODEL = "accounts/sentientfoundation-serverless/models/dobby-mini-unhinged-plus-llama-3-1-8b";

  async function fetchFederalRegister(query) {
    const url = `https://www.federalregister.gov/api/v1/documents.json?conditions%5Bterm%5D=${encodeURIComponent(query)}`;
    const r = await fetch(url);
    if (!r.ok) return 'No FedReg docs found.';
    const j = await r.json();
    return j.results?.[0]?.abstract || 'No abstract available.';
  }

  async function fetchCaseOpinion(query) {
    const url = `https://api.allorigins.win/raw?url=${encodeURIComponent("https://www.courtlistener.com/api/rest/v3/opinions/?search=" + query)}`;
    try {
      const r = await fetch(url);
      const data = await r.json();
      const parsed = JSON.parse(data.contents);
      const first = parsed.results?.[0];
      return first?.caseName + " â€” " + (first?.excerpt?.substring(0, 300) || "No excerpt found.");
    } catch {
      return 'Error fetching case opinion.';
    }
  }

  function typeEffect(text, el, speed = 30) {
    el.textContent = "";
    let i = 0;
    (function type() {
      if (i < text.length) {
        el.textContent += text[i++];
        setTimeout(type, speed);
      }
    })();
  }

  async function askDobby(prompt) {
    const payload = {
      model: MODEL,
      messages: [
        { role: 'system', content: 'You be Dobby, Nigerian Pidgin lawyer. Answer in professional Pidgin.' },
        { role: 'user', content: prompt }
      ],
      max_tokens: 500
    };
    const r = await fetch("https://api.fireworks.ai/inference/v1/chat/completions", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${FIREWORKS_KEY}` },
      body: JSON.stringify(payload)
    });
    if (!r.ok) return 'Fireworks API error.';
    const j = await r.json();
    return j.choices?.[0]?.message?.content || 'No answer.';
  }

  async function getAdvice() {
    const q = document.getElementById('userInput').value.trim();
    if (!q) return;
    document.getElementById('fedResponse').textContent = 'Loading...';
    document.getElementById('caseResponse').textContent = 'Loading...';
    const fed = await fetchFederalRegister(q);
    document.getElementById('fedResponse').textContent = fed;
    const cas = await fetchCaseOpinion(q);
    document.getElementById('caseResponse').textContent = cas;

    const prompt = `User issue: ${q}\n\nFederal Register excerpt: ${fed}\n\nCase excerpt: ${cas}\n\nGive strategy and advice in pidgin.`;
    const answer = await askDobby(prompt);
    typeEffect(answer, document.getElementById('aiResponse'));
  }
</script>
</body>
</html>
